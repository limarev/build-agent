name: Publishing
run-name: Publish new libreoffice release ${{ github.ref_name }}

on:
  push:
    tags:
      - '*'

jobs:
  build:
    runs-on: self-hosted
    strategy:
      matrix:
        arch: [armeabi-v7a, arm64-v8a, x86, x86_64]
    container:
      image: klimarev/lo_co_build_env:1.5
      options: --user user
    env:
      target: android_${{ matrix.arch }}_core_${{ github.ref_name }}
      lo_repo: LibreOffice/core
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          repository: ${{ env.lo_repo }}
          ref: ${{ github.ref_name }}
          submodules: 'recursive'
          path: './core'
      - name: Build info 
        run: |
          echo "üéâ The job was automatically triggered by a ${{ github.event_name }} event."
          echo "üêß This job is now running on a ${{ runner.os }} server!"
          echo "üîé This job builds ${{ env.lo_repo }} repository ${{ github.ref_name }} tag for adnroid."
          echo "This job is run from $(whoami)"
          echo "Current directory is $(pwd)"
          echo "Current directory structure: $(ls -la)"

      - name: Build ${{ env.target }}
        run: |
          mkdir -p ${{ env.target }} && cd ${{ env.target }}
          echo $LIBREOFFICE_SOURCES_DIR
          ./../entrypoint.sh ${{ matrix.arch }}
        env:
          LIBREOFFICE_SOURCES_DIR: ./../core

      - name: Check if ${{ env.target }} contains build files
        run: ls -la ${{ env.target }}

      - name: Archive android_* artifacts
        run: |
          tar czvf ${{ env.target }}.tar.gz ${{ env.target }}

      - name: Upload files to a GitHub release
        uses: svenstaro/upload-release-action@2.7.0
        with:
          file: "*.tar.gz"
          overwrite: true
          file_glob: true
          release_name: android_libreoffice_core_${{ github.ref_name }}
          body: "These are compiled ${{ env.lo_repo }} ${{ github.ref_name }} for Android for 4 platforms: armeabi-v7a, arm64-v8a, x86, x86_64"
      - run: echo "üçè This job's status is ${{ job.status }}."
